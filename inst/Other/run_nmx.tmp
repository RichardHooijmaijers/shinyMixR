if("nlmixr2" %in% rownames(installed.packages())){
  library(nlmixr2)
}else if("nlmixr" %in% rownames(installed.packages())){
  library(nlmixr)
}else{
  cat("You need either the 'nlmixr' or 'nlmixr2' package to run models. This step will crash\n")
}
options(keep.source = TRUE)
if(!exists("{{{data}}}", envir=.GlobalEnv)) {
  if(file.exists("{{{locproj}}}/data/{{{data}}}.rds")){
    data_nlm <- readRDS("{{{locproj}}}/data/{{{data}}}.rds")
  }else if(file.exists("{{{locproj}}}/data/{{{data}}}.csv")){
    data_nlm <- read.csv("{{{locproj}}}/data/{{{data}}}.csv")
  }
}else{
  data_nlm <- {{{data}}}
}
if("{{subs}}"!=""){
  data_nlm <- subset(data_nlm,{{{subs}}})
}

source("{{{modelloc}}}")
setwd("{{{locproj}}}/shinyMixR/temp")
modres <- try(nlmixr({{{modelname}}}, data=data_nlm, est="{{{est}}}",control={{{control}}},table=tableControl(cwres={{{addcwres}}}, npde={{{addnpde}}})))

{{#saveres}}
if(length(class(modres))>1 && class(modres)!="try-error"){
  saveRDS(modres,file="../{{{modelname}}}.res.rds")
  if("nlmixr2" %in% rownames(installed.packages())){
    saveRDS(list(OBJF=modres$objective,CONDNR=modres$conditionNumberCor,partbl=modres$parFixedDf,partblf=modres$parFixed,omega=modres$omega,
                 tottime=rowSums(modres$time)),file="../{{{modelname}}}.ressum.rds")
  }else{
    saveRDS(list(OBJF=modres$objective,partbl=modres$popDf,partblf=modres$par.fixed,omega=modres$omega,
                 tottime=rowSums(modres$time)),file="../{{{modelname}}}.ressum.rds")
  }
}
{{/saveres}}
cat("run finished!\n")